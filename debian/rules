#!/usr/bin/make -f

PHPAPI := $(shell php-config --phpapi)
PYTHON_SITELIB := $(shell python -c 'from distutils.sysconfig import get_python_lib; print get_python_lib()')
PYTHON_SITEARCH := $(shell python -c 'from distutils.sysconfig import get_python_lib; print get_python_lib(1)')

%:
	dh $@ --parallel --with pkgkde_symbolshelper

override_dh_auto_configure:
	dh_auto_configure -- \
		-DSWIG=/usr/bin/swig2.0 \
		-DUSE_LIBCALENDARING=ON \
		-DPHP_BINDINGS=ON \
		-DPHP_INSTALL_DIR=/usr/lib/php5/$(PHPAPI)/ \
		-DPHP4_EXECUTABLE=/usr/bin/php5 \
		-DPHP4_INCLUDE_PATH=/usr/include/php5/ \
		-DPYTHON_BINDINGS=ON \
		-DPYTHON_INSTALL_DIR=$(PYTHON_SITEARCH)

binary-arch:
	echo "php:Depends=phpapi-${PHPAPI}" >> debian/php-kolab.substvars
	dh binary-arch

override_dh_install:
	# Create ini file in usr/share/php5/kolab
	# Will be installed/enabled in maintainer scripts
	mkdir -p debian/tmp/usr/share/php5/kolab
	echo "extension=kolabformat.so" >> debian/tmp/usr/share/php5/kolab/kolab.ini
	echo "extension=kolabshared.so" >> debian/tmp/usr/share/php5/kolab/kolab.ini
	echo "extension=kolabobject.so" >> debian/tmp/usr/share/php5/kolab/kolab.ini
	echo "extension=kolabcalendaring.so" > debian/tmp/usr/share/php5/kolab/kolab.ini
	# 
	mkdir -p debian/tmp/usr/share/php
	mv debian/tmp/usr/lib/php5/$(PHPAPI)/kolabcalendaring.php debian/tmp/usr/share/php/kolabcalendaring.php
	mv debian/tmp/usr/lib/php5/$(PHPAPI)/kolabicalendar.php debian/tmp/usr/share/php/kolabicalendar.php
	mv debian/tmp/usr/lib/php5/$(PHPAPI)/kolabobject.php debian/tmp/usr/share/php/kolabobject.php
	mv debian/tmp/usr/lib/php5/$(PHPAPI)/kolabshared.php debian/tmp/usr/share/php/kolabshared.php
	dh_install --fail-missing

override_dh_auto_test:
	dh_auto_test || :
